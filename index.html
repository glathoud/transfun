<!doctype html>
<!-- Copyright Guillaume Lathoud 2016
     Boost License: see the file ./LICENSE
-->
<html>
  <head>
    <meta charset=utf-8/>
    <title>transfun</title>
    <style type="text/css">
    body { font-family: helvetica; max-width: 600px; margin: auto;

line-height: 1.5em;
    text-align: justify;
    font-family: Verdana,Arial,'Lucida Grande',Sans-Serif;
         }
    .highlight { margin-top: 2em; text-decoration: underline; }
    .highlight-anchor { visibility: hidden; }
    .highlight:hover .highlight-anchor { visibility: visible; }
    .left { float : left; }
    .right { float : right; }
    .clear { clear: both; }
code { font-size: 1.1em; }
dd { margin-bottom: 1em; }
    .legend { font-weight: bold; text-align: center; margin-bottom: 1.5em; margin-top: 0.35em; font-style: italic; }
    .centered-pic { text-align: center; margin-top: 3em; margin-bottom: 2em; }
    .centered-cell { text-align: center; vertical-align: middle; padding-left: 1.75em; padding-right: 0;}
    .yes-no img { max-width : 1.25em; }
    .done { text-decoration: line-through; }

#title { margin-bottom: 6em; }
    .section-hr, .section-title {margin-top: 2.5em; }
.email_icon { vertical-align: middle; max-height: 2.25em; }



@media only print  { .print-hidden, .section-anchor, .highlight-anchor { visibility: hidden; } }

    .license { width: 110%; height: 400px; border: none; margin: 0; paddin: 0; overflow: hidden; }
    </style>
    <link rel="stylesheet" type="text/css" href="rsrc_web/prettify/prettify.css"/>
    <script type="text/javascript" src="transfun.js"></script>
    <script type="text/javascript" src="rsrc_web/opinel.js"></script>
  </head>
  <body>
    <script type="text/javascript">
(function () {
    
    var c_transfun  = hh.code( 'transfun.js' )
    ,   c_appfun    = hh.code( 'appfun' )
    ,   c_arr       = hh.code( 'arr' )

    ,   c_lazy      = hh.code( 'lazy.js' )

    ,   c_m         = hh.code( 'map' )
    ,   c_mfr       = hh.code( 'map/filter/reduce' )

    ,   c_mfr_etc       = hh.code( 'map, filter, reduce, redinit, and, or' )
    ,   c_mfr_etc_in    = hh.code( 'mapIn, filterIn, reduceIn, redinitIn, andIn, orIn ' )
    ,   c_mfr_etc_right = hh.code( 'mapRight, filterRight, reduceRight, redinitRight, andRight, orRight' )

    ,   c_o2arr_conv    = hh.code( 'o2values, o2keys, keys2o' ) + ' and ' + hh.code( 'o2kv, kv2o' )

    ,   c_current       = hh.code( 'current' )
    ,   c_arg           = hh.code( 'arg' )

    ,   c_range_direct  = hh.code( 'range, rangeStep, rangeRight, rangeRightStep' )
    ,   c_range_of      = hh.code( 'rangeOf, rangeStepOf, rangeRightOf, rangeRightStepOf' )
    ,   c_range         = c_range_direct + ' &amp;&nbsp;parameterized&nbsp;variants ' + c_range_of

    ,   c_next      = hh.code( 'next' )

    ,   c_parallel  = hh.code( 'parallel.js' )
    
    ,   c_tval      = hh.code( 'tval' )

    ,   c_bind      = hh.code( 'bind' )

    ,   c_wu        = hh.code( 'wu.js' )
    
    ,   github_ref  = 'http://github.com/glathoud/transfun'
    ,   haskell_ref = 'http://chrisdone.com/posts/stream-composability' // 'https://www.reddit.com/r/programming/comments/2s5gj2/java_8_no_more_loops/cnn30vn'

    ,   lazy_ref = 'https://github.com/dtao/lazy.js/'
    
    ,   nokeyorder_ref     = 'http://stackoverflow.com/questions/30076219/does-es6-introduce-a-well-defined-order-of-enumeration-for-object-properties'

    ,   parallel_ref = 'https://github.com/glathoud/transfun/blob/master/plugin/parallel.js'
    ,   parallel_example_ref = 'test.html#async-unit-test'

    ,   transducers_js_ref = 'https://www.reddit.com/r/javascript/comments/42sxfb/understanding_transducers_in_javascript/'

    ,   jsperf_motivation = 'http://jsperf.com/arr-map-filter-reduce/4'
    ,   test_ref = 'test.html'
    ,   test_run_it_ref = test_ref + '#speed-test'

    ,   wu_ref = 'https://github.com/fitzgen/wu.js/'

    ,   sp_yes = hh( 'span class="yes-no"', hh( 'img src="rsrc_web/img/pic_yes.png"' ) )
    ,   sp_no  = hh( 'span class="yes-no"', '' )  // hh( 'img src="rsrc_web/img/pic_no.png"' ) )

    ,   comp_table_sep = [ { comp_table_sep : true } ]
    
    ,   st_arr = [];
    ;
    
    document.write([

        hh.p([
            hh( 'span class="right"', '&rarr;&nbsp;' + hh( 'a href="./test.html"', 'Test page' ) )
            , hh( 'div class="clear"' )
            , hh( 'span class="right"', '&rarr;&nbsp;' + hh( 'a href="' + github_ref + '"', 'GitHub' ) )
            , hh( 'div class="clear"' )
            , hh( 'span class="right"', '&rarr;&nbsp;' + hh( 'a href=".."', 'Home' ) )
        ])
        , hh( 'div class="clear"' )
        , hh( 'div id="title"'
              ,[
                                    ,hh.h1( [ c_transfun ] )

                                 , hh( 'p id="by" class=""', 'by G. Lathoud, January 2016' )

                ]
          )

        , hh( 'div class="clear"' )
       
        , hh.p([
            , c_transfun + ' is a JavaScript library that'
            , ' lets you write ' + c_mfr + ' code that runs much faster than the equivalent '
            , '  native ' + c_mfr + ' code:'
        ] )

        , hh.p([
            hh( 'img src="rsrc_web/img/jsperf_safari.png"' )
        ])
        
        , highlight( 'Merging loops for speed' )
        
        , hh.p([

            , c_transfun + ' automatically merges consecutive loops'
            , ' into one loop, '
            ,  ' then generates fast code for that loop '
            , ' (similar to stream fusion in &rarr;&nbsp;' 
            , hh( 'a href="' + haskell_ref + '"', 'Haskell' ) + ').'
        ])

        , highlight( 'Extensibility' )
        
        , hh.p([
            , 'A domain-specific language is used to define ' + c_mfr + '. With this language, library&nbsp;users can  '
            , '  define other transformations: '
            , hh.code( 'sum' ) + ', ' + hh.code( 'and' ) + ', ' + hh.code( 'or' ) + '...'
        ])

        , highlight( 'For the hurried ones' )

        , hh.p([
            '...you can jump directly to the '
            , hh( 'a href="#speed-result"', 'speed results' )
            , '.'
        ])

        , highlight( 'Plugins' )

        , hh.dl([
            dl_describe(
                c_parallel + ' plugin'
                , ['To split an ' + c_appfun + ' across web workers, using 1, some or all of the other available CPU cores: '
                   , hh( 'a href="' + parallel_example_ref + '"', 'Example of use' )
                   , ',&nbsp; '
                   , hh( 'a href="' + parallel_ref + '"', 'plugin source code' )                
                  ]
            )
        ])

        , highlight( 'Related topics' )

        , hh.p([
            'These might also interest you:'
        ])

        , hh.ul([
            
            hh.li([ '&rarr;&nbsp;'
                    , hh( 'a href="http://chrisdone.com/posts/stream-composability"'
                          , 'Stream fusion and composability (Java 8 and Haskell) for newbies'
                        )
                  ])
            
            , hh.li([ '&rarr;&nbsp;', hh( 'a href="https://blogs.janestreet.com/flambda/"'
                        , 'A better inliner for OCaml, and why it matters'
                      )])

            , hh.li([ '...and much more in '
                      , hh( 'a href="#annex-related-topics"', 'Annex' )
                      , '.'
            ])
        ])
        
        , section_title_with_anchor( '', 'Contents' )
        , hh( 'p id="contents"' )

        , section_title_with_anchor( 'motivation', 'Motivation: Performance issue' )

        , hh.p( 'Consider an array of objects provided by an unreliable data source:' )

        , js_pre_code([
            'arr = [ { p : 18, ... }, { p : null, ... }, { p : 47, ... }, ... ]',
            '                               ^^^^',
            '                 missing data (null or undefined)'
        ])

        , hh.p([
            'where we want to compute the sum of of the '
            , hh.code( 'p' )
            , ' values, ignoring the missing data.'
        ])

        , hh.p([
            'The native ' + c_mfr + ' array methods permit to write this '
            , 'in a way that clearly separates the 3 steps (ES6 notation):'
        ])

        , js_pre_code([
            'arr.map((x) => x.p).filter((x) => x != null).reduce((a,b) => a + b)',
            '',
            '1. take the p values',
            '                    2. ignore missing data.',
            '                                             3. sum...............'
        ])
        , legend( 'Native code' )
        
        , hh.p([
            'The code structure is concise ' + hh.em( 'and' ) + ' close to that of a  human language description. '
            , 'This leads to very maintainable code - in particular '
            , 'it can be changed with less chance to introduce a bug, as when we would write a for loop. ' 
        ])

        , hh.p([
            'BUT in performance-critical parts of a program, two issues arise: '
        ])

        , hh.ul([
            hh.li( '(1) one function call per array element,' )
            , hh.li( '(2) several intermediary arrays created.' )
        ])

        , js_pre_code([
            'arr.map((x) => x.p).filter((x) => x != null).reduce((a,b) => a + b)',
            '            ^^     ^           ^^           ^             ^^',
            '            (1)   (2)          (1)         (2)            (1)',
        ])

        , hh.p( 'To solve problem (1), one ends up writing ' + hh.code( 'for' ) + ' loops by hand:' )

        , js_pre_code([

            '// .map(".p")',
            'var tmp_1 = new Array(n);    // intermediary array (problem 2)', 
            'for (var i = 0; i < n; i++)',
            '  tmp_1[i] = arr[i].p;',
            '',
            '// .filter("!=null")',
            'var tmp_2 = [];    // intermediary array (problem 2)',
            'for (var i = 0; i < n; i++) {',
            '  var v = tmp_1[i];',
            '  if (v != null)',
            '    tmp_2.push(v);',
            '}',
            '',
            '// .reduce("+")',
            'var sum = 0;',
            'for (var n2 = tmp_2.length, i = 0; i < n2; i++)',
            '  sum = sum + tmp_2[i];',
        ])

        , legend( '3-loop code (written by hand)' )
        
        , hh.p( '...then, to solve problem (2), one merges the 3 loops into a single loop: ')

        , js_pre_code([
            
            'var sum = 0,',
            'n = arr.length;',
            'for (var i = 0; i < n; i++) {',
            '  var v = arr[i];',
            '  v = v.p; // .map(".p")',
            '  if (v != null) // .filter("!=null")',
            '    sum = sum + v; // .reduce("+")',
            '}',

        ])
        , legend( '1-loop code (written by hand)' )
        
        , hh.p([
            'This leads to a huge speedup (full results on &rarr;&nbsp;'
            , hh( 'a href="' + jsperf_motivation + '"', 'jsPerf' )
            , '):'
        ])

        , hh.p([
            hh( 'a href="' + jsperf_motivation + '"', hh( 'img src="rsrc_web/img/jsperf_motivation.png" title="click for full results on jsPerf"' ))
        ])

        , hh.p([
            '...but the 1-loop code can be difficult to read, maintain and change without introducing bugs.'
        ])

        , hh.p([
            'Ideally, we would like to write code ' + hh.em( 'similar' ) + ' to this:'
        ])
        , js_pre_code([
            'arr.map((x) => x.p).filter((x) => x != null).reduce((a,b) => a + b)',
        ])

        , '...and have it run as fast as the 1-loop code:'
        , js_pre_code([
            
            'var sum = 0,',
            'n = arr.length;',
            'for (var i = 0; i < n; i++) {',
            '  var v = arr[i];',
            '  v = v.p; // .map(".p")',
            '  if (v != null) // .filter("!=null")',
            '    sum = sum + v; // .reduce("+")',
            '}',
            
        ])

        , ' This is the goal of ' + c_transfun + '.'

        , centered_pic( 'castlekids' )

        , highlight( 'Interlude: Personal story' )

        , hh.p([
            'In frontend production code, I have been using for years '
            , ' tools inspired from '
            , hh( 'a href="http://bill.dojotoolkit.org/api/1.9/dojox/lang/functional"', hh.code( 'dojox.lang.functional' )) 
            , ', that solve problem 1, but not problem 2 (intermediary arrays). '
        ])

        , hh.p([
            'Concretely: After repeatedly writing things like this:'
        ])

        , js_pre_code([
            'var p_values = lib.map( lib.filter( arr, "!=null" ), ".p" );',
            '//                  4          2     1       3         5'
        ])
        
        , hh.p([
            '...I had two thoughts:'
        ])

        , hh.ul([
            hh.li( 'Can we improve the "read order" of the code (1,2,3,4,5)?' )
            , hh.li( ' Can we get rid of the temporary array created between 3 and 4?' )
        ])

        , centered_pic( 'alchemyequipment' )








        
        , section_title_with_anchor( 'solution', 'The ' + c_transfun + ' solution' )
        
        , hh.p(['Instead of '
            , 'passing function arguments to ' + c_mfr + ' to produce a result value in 1&nbsp;step: '
        ])

        , js_pre_code([
            'var result = arr.map((x) => x.p)',
            '  .filter((x) => x != null)',
            '  .reduce((a,b) => a + b);',
        ])
        , legend( 'Native code' )

        , hh.p([
            '...' + c_transfun + ' has 2 steps, which rely on a similar but slightly different syntax, first passing ' + hh.em( 'code expressions' ) + ' to produce an ' + hh.em( 'application function' ) + ': '
        ])

        , js_pre_code([
            "var appfun = tfun.map( '.p' ).filter( '!=null' ).reduce( '+' );",
        ])
        , legend( c_transfun + ' code' )

        , hh.p([
            '...then in a 2nd&nbsp;step, calling ' + c_appfun + ' on some data ' + c_arr + ' to produce a result:'
        ])
        
        , js_pre_code([
            "var result = appfun( arr ); // very fast!"
        ])

        , hh.p([
            'This runs very fast, because, behind the scenes, ' + c_transfun + ' generates single-loop code whenever possible:'
        ])
        , js_pre_code( tfun.map( '.p' ).filter( '!=null' ).reduce( '+' ).getBodyCode() )
        , legend(
            'Internal code generated by ' + c_transfun
                + hh('br') + '(generated while this article loaded)'
        )
        
        , hh.p([
            'If you want, you can jump directly to the '
            , hh( 'a href="#speed-result"', 'speed results' )
            , '.'
        ])





        , centered_pic( 'function' )

        , section_title_with_anchor( 'with-functions', 'Usage with function arguments' )

        , hh.p([
            c_transfun + ' also supports function arguments:'
        ])

        , js_pre_code([
            'var appfun = tfun.map((x)=>x.p).filter((x)=>x!=null)',
            '             .reduce((a,b)=>a+b);',
            'var result = appfun( arr );'
        ])
        
        , hh.p([
            '...which generates an implementation with external function calls:'
        ])

        , js_pre_code(
            tfun.map(function (x) { return x.p })
                .filter(function (x) { return x != null; })
                .reduce( function (a, b ) { return a + b; })
                .getBodyCode()
        )
        , legend(
            'Internal code generated by ' + c_transfun
                + hh('br') + '(generated while this article loaded)'
        )

        
        , hh.p([
            'The code runs slower than the one based on expression strings,'
            , ' but still&nbsp;faster than the native array ' + c_mfr + ' methods.'
        ])

        , highlight( 'Personal opinion' )

        , hh.p([
            'If I need conciseness and performance, I\'ll use expression strings. ',
            'However, if I have a function that is either:'
        ])
        , hh.ul([
            hh.li( '(a)&nbsp;too complicate to reasonably be written as an expression string,' ),
            hh.li( ' or (b)&nbsp;reused somewhere else,' )
        ])
        , hh.p([ 'then I\'ll use a function argument. By the way, ',
            'it is perfectly possible to mix the two:'
        ])
        , js_pre_code([
             "var appfun = tfun.map(someFunction).filter('!=null').reduce('+');"
        ])
        , hh.p([
            'Additionally, the flexibility provided by '
            , hh( 'a href="#tval"', hh.code( 'tval' ) )
            , ' and '
            , hh( 'a href="#bind"', hh.code( 'bind' ) )
            , ' permits to write code in the order that suits the context.'
        ])
        , hh.p([
            'If you like this type of topic, have a look at that article: <br> &rarr;'
            , hh( 'a href="' + transducers_js_ref + '" target="_blank"'
                  , 'Understanding Transducers in JavaScript' 
                )
            , '.'
        ])

        , highlight( 'Acknowledgement' )

        , hh.p([
            'Many thanks to the reddit user '
            , hh( 'a href="https://www.reddit.com/user/ugwe43to874nf4"', 'ugwe43to874nf4' )
            , ' for the '
            , hh( 'a href="https://www.reddit.com/r/javascript/comments/42wq9f/merging_loops_for_speed_in_javascript_library/"', 'feedback' )
            , '.'
        ])
        




        , centered_pic( 'toolbox' )

        , section_title_with_anchor( 'toolbox', [
            'Also predefined: ' + hh.code( 'mapIn' ) + ', ' + hh.code( 'and' ) + ', ' + hh.code( 'or' )
            , ', ' + hh.code( 'o2keys')
            , '...'
        ])

        , hh.p([
            'Beside ' + c_mfr + ', other transformations are also predefined:'
        ])
        

        , hh.dl([
            
            dl_describe(
                c_mfr_etc
                , 'take array input and loop left-to-right.'
            )
            
            , dl_describe(
                c_mfr_etc_right
                , 'take array input and loop ' + hh.em( 'right-to-left' ) + '.'
            )
            
            , dl_describe(
                c_mfr_etc_in
                , [ 'take ' + hh.em( 'object input' ) + ' and loop through keys: they are not array-specific. '
                    , 'Moreover,&nbsp;the key order is '
                    , hh( 'a href="' + nokeyorder_ref + '"'
                        , 'not guaranteed'
                      )
                    , '.'
                  ]
            )

            , dl_describe(
                c_o2arr_conv
                , [ 
                    'convert objects to arrays and vice-versa (examples further below).' 
                ]
            )
            
            , dl_describe(
                c_arg
                , [
                    'permits to define multiple arguments, instead of the standard single argument ' + c_current + '.'
                ]
            )

            , dl_describe(
                c_range
                , [
                    'permit to loop on numerical ranges.'
                ]
            )
        ])

        , highlight([
            'Examples with ' + hh.code( 'and/or' ) + ':'
        ])
        , js_pre_code([
            "tfun.and     // transformation function (arity 0)",
            "tfun.and()   // application function",
            "",
            "tfun.and()     ([])          //>> true",
            "tfun.and()     ([ 1, 'a' ])  //>> 'a'",
            "tfun.andRight()([ 1, 'a' ])  //>> 1",
            "tfun.and()     ([ 1, 'a', false, 33, null, 17 ])  //>> false",
            "tfun.andRight()([ 1, 'a', false, 33, null, 17 ])  //>> null",
            "",
            "tfun.andIn()({ p:1, q:'aa', r:'xyz' })  //>> <one of: 1, 'aa' or 'xyz'>",
            "tfun.andIn()({ p:1, q:null, r:'xyz' })  //>> null",
        ])
        , js_pre_code([
            "tfun.or()     ([])          //>> false",
            "tfun.or()     ([ 1, 'a' ])  //>> 1",
            "tfun.orRight()([ 1, 'a' ])  //>> 'a'",
            "tfun.or()     ([ false, 0, null ])  //>> null",
            "tfun.orRight()([ false, 0, null ])  //>> false",
            "",
            "tfun.orIn()({ p:1, q:'aa', r:'' })  //>> <one of: 1 or 'aa'>",
            "tfun.orIn()({ p:1, q:null, r:'' })  //>> 1",
            "",
        ])

        , highlight( 'Note about arity-0 transformations' )

        , hh.p([
            'Several transformation functions have arity 0 &mdash; i.e. need no parameter: '
        ])
        , js_pre_code([
            "tfun.and()   // application function"
        ])
        , hh.p([ 'which leads to the usage:' ])
        , js_pre_code([
            "tfun.and()([ 1, 'a' ])  // result: 'a'"
        ])
        , hh.p([
            , 'I chose '
            , hh.em( 'not' )
            , ' to permit shortcuts like '
            , hh.code( 'tfun.and([ 1, \'a\' ])' )
            , ' because it leads to inconsistencies as well as implementation issues, especially when '
            , hh( 'a href="#chaining"', 'chaining' )
            , '.'
            , ' See also '
            , hh( 'a href="https://github.com/glathoud/transfun/issues/4")', 'GitHub issue #4' )
            , ' for more details.'            
        ])
        


        , highlight([
            '"Values" extraction:'
        ])

        , hh.dl([


            dl_describe(
                hh.code( 'o2values' )
                , [
                    'converts an object to the array of its values:'
                    , js_pre_code([
                        "tfun.o2values()({ a:1, b:'xyz', c:null })",
                        "// *may* return:",
                        "[ 'xyz', 1, null ]"
                    ])
                    , '"' + js_code( '*may*' ) + '": The array order is '
                    , hh( 'a href="' + nokeyorder_ref + '"'
                        , 'not guaranteed'
                        )
                    , '.'
                ]
            )
        ])
        

        , highlight([
            '"Key" conversions:'
        ])

        , hh.dl([

            dl_describe(
                hh.code( 'o2keys' )
                , [
                    'converts an object to the array of its ' + hh.em( 'keys' ) + ' (it wraps ' + hh.code( 'Object.keys' ) + '): '
                    , js_pre_code([
                        "tfun.o2keys()({ a:1, b:'xyz', c:null })",
                        "// *may* return:",
                        "[ 'b', 'a', 'c' ]"
                    ])
                    , '"' + js_code( '*may*' ) + '": The array order is '
                    , hh( 'a href="' + nokeyorder_ref + '"'
                        , 'not guaranteed'
                        )
                    , '.'
                ]
            )

            , dl_describe(
                hh.code( 'keys2o' )
                , [
                    'converts an array to an object. For example:'
                    , js_pre_code([
                        "tfun.keys2o()([ 'a', 'b', 'c' ])",
                        '// returns:',
                        "{ a:true, b:true, c:true }"
                    ])
                ]
            )
        ])

        , highlight([
            '"Key-value" conversions:'
        ])

        , hh.dl([
            dl_describe(
                hh.code( 'o2kv' )
                , [
                    'converts an object to the array of its key-value pairs:'
                    , js_pre_code([
                        "tfun.o2kv()({ a:1, b:'xyz', c:null })",
                        '// *may* return:',
                        "[ ['c', null], ['a', 1], ['b', 'xyz'] ]"
                    ])
                    , '"' + js_code( '*may*' ) + '": The array order is '
                    , hh( 'a href="' + nokeyorder_ref + '"'
                        , 'not guaranteed'
                        )
                    , '.'
                ]
            )

            , dl_describe(
                hh.code( 'kv2o' )
                , [
                    'converts an array of key-value pairs to an object:'
                    , js_pre_code([
                        "tfun.kv2o()([ ['b', 'xyz'], ['a', 1], ['c', null] ])",
                        '// returns:',
                        "{ a:1, b:'xyz', c:null }"
                    ])
                ]
            )
             
        ])

        , highlight( 'Multiple arguments:' )

        , hh.dl([
            dl_describe(
                hh.code( 'arg' )
                , [
                    'defines multiple arguments:'
                    , js_pre_code([                       
                        "tfun.arg( 'a,b,c' ).next( 'a+b*c' )"
                        , "// function (a,b,c) { return a+b*c; }"
                    ])
                ]
            )
        ])

        , highlight( 'Ranges:' )

        , hh.dl([
            dl_describe(
                c_range_direct
                , [
                    'define numerical ranges:'
                    , js_pre_code([
                        "tfun.range()( 3, 7 )             // " + JSON.stringify( tfun.range()( 3, 7 ) )
                        , "tfun.rangeRight()( 7, 3 )        // " + JSON.stringify( tfun.rangeRight()( 7, 3 ) )
                        , ""
                        , "tfun.rangeStep()( 3, 7, 2 )      // " + JSON.stringify( tfun.rangeStep()( 3, 7, 2 ) )
                        , "tfun.rangeStepRight()( 7, 3, 2 ) // " + JSON.stringify( tfun.rangeStepRight()( 7, 3, 2 ) )
                    ])
                ]
            )

            , dl_describe(
                c_range_of
                , [
                    'define parameterized numerical ranges. '
                    , 'Example with constants:'
                    , js_pre_code([
                        "tfun.rangeOf( '3', '7' )()  // [" + tfun.rangeOf( '3', '7' )() + "]"
                    ])
                    , 'Example with variables:'
                    , js_pre_code([
                        "var appfun = tfun.arg( 'begin,end' ).rangeOf( 'begin', 'end' )"
                        , ""
                        , "// Generated code:"
                        , "" + tfun.arg( 'begin,end' ).rangeOf( 'begin', 'end' )
                        , ""
                        , '// Example use:'
                        , "appfun( 3, 7 ) // " + JSON.stringify( tfun.arg( 'begin,end' ).rangeOf( 'begin', 'end' )( 3, 7 ) )
                    ])
                    , 'similarly:'
                    , js_pre_code([
                        "tfun.rangeRightOf( 'begin', 'end' )"
                        , ""
                        , "tfun.rangeStepOf( 'begin', 'end', 'step' )"
                        , "tfun.rangeStepRightOf( 'begin', 'end', 'step' )"
                    ])
                    , 'Ranges can be combined with other transformations.'
                    , hh.p( 'Example: pick a subset of a sparse array and modify it:' )
                    , js_pre_code([
                        "var appfun = tfun.arg( 'arr,begin,end' )"
                        , "  .range( 'begin', 'end')"
                        , "  .filter( 'v in arr')"
                        , "  .map( 'arr[v]-k')"
                        , ""
                        , "// Generated code:"
                        , "" + tfun.arg( 'arr,begin,end' ).rangeOf( 'begin', 'end' ).filter( 'v in arr' ).map( 'arr[v]-k' )
                    ])
                ]
            )
            
            
        ])
        

        , highlight( 'Published transformations and namespaces' )

        , hh.p([
            ' The "published" transformations, i.e. transformations created with ' + js_code( 'tpub' ) + ', can be accessed by anyone through '
            , js_code( 'tfun.*' ) + ' methods:'
        ])
        , js_pre_code([
            'tfun.map',
            'tfun.filter',
            '// etc.'
        ])
        
        , hh.p([ 'For example:' ])
        , js_pre_code([
            "var appfun = tfun.map( '.p' ).filter( '!=null' ).reduce( '+' );",
        ])






        
        , centered_pic( 'oldcpu' )
        , section_title_with_anchor( 'practical', 'Negligible CPU overhead' )
        
        , hh.p([
            'As mentionned above, '
            , 'the '
            , c_transfun
            , ' approach has two steps:'
        ])

        , js_pre_code([
            "var appfun = tfun.map( '.p' ).filter( '!=null' ).reduce( '+' );",
            "var result = appfun( arr ); // very fast!"
        ])
        
        , hh.p([
            'The cost of the first step &mdash; creating the '
            , js_code( 'appfun' )
            , ' &mdash; is negligible (see&nbsp;&rarr;'
            , hh( 'a href="https://github.com/glathoud/transfun/issues/2" class="issue_closed"'
                  , '#2' )
            , '), so one can write the two steps in a single line:'
        ])

        , js_pre_code([
            "var result = tfun.map( '.p' ).filter( '!=null' ).reduce( '+' )( arr );",
        ])

        , hh.p([
            'However, I personally don\'t like the order in which the terms of that line read,'
            , ' but that can be fixed. See the next Section.'
        ])



        
        

        , centered_pic( 'pipechair' )
        , section_title_with_anchor( 'tval', 'Convenient pipe-like order using ' + c_tval )

        , hh.p([
            'If you write things in a single line:'
        ])
        , js_pre_code([
            "var result = tfun.map( '.p' ).filter( '!=null' ).reduce( '+' )( arr )",
            "//                   2              3                  4         1"
        ])
        , hh.p([
            '...the reading order might be a bit confusing, because the input value '
            , hh.code( 'arr' ) 
            , ' is at the end&nbsp;(1), while the rest&nbsp;(2,3,4) follows a pipe-like order.'
        ])
        , hh.p([
            'In such cases you can use ' + c_tval + ' to improve the reading order, putting the data ' 
            , c_arr
            , ' first:'
        ])
        , js_pre_code([
            "var result = tval( arr )( tfun.map('.p').filter('!=null').reduce('+') );",
            "//                  1        2            3                4"
        ])
        , hh.p([
            "There is no magic here: "
            , c_tval
            , ' simply applies the appfun&nbsp;(2,3,4) on its data parameter&nbsp;(1). '
        ])
        , hh.p([ ' Generally:' ])
        , js_pre_code([
            'tval( <data> )( <appfun> ) === <appfun>( <data> )'
        ])
        
        


        


        , centered_pic( 'now_later' )
        , section_title_with_anchor( 'bind', 'Hiding away complexity using ' + c_bind )

        , hh.p([
            'It is not realistic to write code strings that are too complex/too long. '
        ])

        , hh.p([
            , 'One solution hides away complex processing of a piece of data using '
            , hh( 'a href="#with-functions"', 'function arguments' )
            , '. '
        ])

        , hh.p([
            'Another solution sticks to '
            , hh.em( 'short' )
            , ' code strings, and uses ', hh.code( 'this' ) , ' and ', hh.code( 'bind' )
            , ' to hide away complexity into an '
            , ' object, as shown below.'
        ])

        , hh.p([
            hh('small', [
                ' Note: functions and RegExps are also objects in JavaScript. '
            ])
        ])
        

        , highlight( 'Example: ' + js_code( 'bind' ) + ' a function' )
        , js_pre_code([
            "// Split text lines and parse each line into an object"
            , "data = tval("
            , "  csv.split( /[\\r\\n]+/ )"
            , ")("
            , "  tfun.filter( '' )"
            , "    .map( 'this(v.split(\",\"))' )"
            , "    .bind( extract_one )"
            , ");"
            , ""
            , "function extract_one( array_of_strings ) {"
            , "  // Returns an object"
            , "  // (too many steps to be reasonably coded in a code string)"
            , "}"
        ])

        , highlight( 'Example: ' + js_code( 'bind' ) + ' a RegExp' )

        , hh.p([
            'Here is a ' + js_code( 'bind' ) + ' example with a RegExp outside of the code string  (goodbye&nbsp;double&nbsp;backslashes): '
        ])
        
        , js_pre_code([
            '// Parse the 3rd string into an object',
            'transaction_a = tval(',
            '  arr[ 3 ].split( /\s+/ )',
            ')(',
            "  tfun.filter( '' )",
            "    .map( '(v=v.match(this)),' +",
            "          '{name:v[1], delta:parseFloat(v[2])}' )",
            "    .bind( /^([^\\+\\-]+)([\\+\\-]\\S+)$/ )",
            ");"
        ])
        
        , highlight( 'Example: ' + js_code( 'bind' ) + ' an object' )

        , hh.p([
            'Here is a ' + js_code( 'bind' ) + ' example with an object containing a parameter ' + js_code( 'v_in' ) + ':'
        ])

        , js_pre_code([
            "// Convert an object to ready-to-print text"
            ,"v_out = tval("
            ,"  final_share"
            ,")("
            ,"  // Data extraction, sorted per key (name)"
            ,"  tfun.o2kv()"
            ,"    .sorted( 'a[0]<b[0] ? -1 : +1' )"
            ,"     // Presentation"
            ,"    .map( 'v[0] + \": \" + this.v_in * v[1]' )  // <<< here: this.v_in"
            ,"    .bind( { v_in : v_in } ) // Parameter: v_in"
            ,")"
            ," .join( '\\n' )"
            ,";"
        ])
        
        , hh.p([
            'Note: instead of: '
            , js_pre_code( "    .map( 'v[0] + \": \" + this.v_in * v[1]' )  // <<< here: this.v_in" )
            , '...we could put the '
            , js_code( 'v_in' )
            , ' value directly into the code string:'
            , js_pre_code( "    .map( 'v[0] + \": \" + ' + v_in + ' * v[1]' )" )
            , '...but then for each different value of '
            , js_code( 'v_in' )
            , ', a new code would be generated, which would be pretty inefficient.'
        ])

        , centered_pic( 'mccreadygossamer' )

        , section_title_with_anchor( 'speed-test', 'Speed test' )

        , hh.p( 'We create an array of 10000 objects, each with a ' + hh.code( 'p' ) + 
                ' property, that is either a number, or ' + hh.code( 'null' ) + ':'
              )
        , js_pre_code([
            'arr = [ { p : 18, ... }, { p : null, ... }, { p : 47, ... }, ... ]',
            '                               ^^^^',
            '                 missing data (null or undefined)'
        ])
        
        , hh.p([ 'The task is to compute the sum of the available ' + hh.code( 'p' ) + ' numbers,'
                 , ' ignoring the ' + hh.code( 'null' ) + ' values.' 
               ])

        , hh.p([ 
            'Below are the various implementation tested (see above for details): '
        ])
        
        , js_pre_code([
            '// -- [transfun.js] --',
            "var appfun = tfun.map( '.p' ).filter( '!=null' ).redinit( '0', '+' );",
            "var result = appfun( arr );"
        ])
        
        , js_pre_code([
            '// -- [1 loop (by hand)] --',
            'var result = 0, n = arr.length;',
            'for (var i = 0; i < n; i++) {',
            '  var v = arr[i];',
            '  v = v.p; // .map(".p")',
            '  if (v != null) // .filter("!=null")',
            '    result = result + v; // .reduce("+")',
            '}'
        ])
        
        , js_pre_code([
            '// -- [3 loops (by hand)] --',
            '// .map(".p")',
            'var tmp_1 = new Array(n);    // intermediary array (problem 2)', 
            'for ...',
            '// .filter("!=null")',
            'var tmp_2 = [];    // intermediary array (problem 2)',
            'for ...',
            '// .reduce("+")',
            'var result = 0;',
            'for ...'
        ])

        , js_pre_code([
            '// -- [native] (problems 1 and 2) --',
            'var result = arr.map((x) => x.p)',
            '  .filter((x) => x != null)',
            '  .reduce((a,b) => a + b);'
        ])







        , section_title_with_anchor( 'speed-result', 'Speed results' )
        , hh.p([
            'Below are the summarized speed results (full results on the &rarr;&nbsp;'
            , hh( 'a href="' + test_run_it_ref + '"', 'test page' )
            , '):'
        ])
        , hh.pre( hh.code([
            'Chrome 47 on a Win7 machine',
            '',
            '[transfun.js]      speed:  31480 ops/sec  &ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;',
            '[1loop (by hand)]  speed:  31225 ops/sec  &ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;',
            '[3loops (by hand)] speed:  11155 ops/sec  &ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;',
            '[native]           speed:    410 ops/sec  &ndash;'
        ].join( '\n' )))

        , hh.p([
            'The goal has been reached: ' + c_transfun + ' lets us write clean and concise code '
            , 'AND provides the same speed as a single for loop written by hand.'
        ])

        , hh.p([
            c_transfun + ' runs about 100 times faster than the equivalent native code.'
        ])

        
        , highlight( 'Run it!' )
        , hh.p([
            'You can run the speed test in your browser on the &rarr;&nbsp;' 
            , hh( 'a href="' + test_run_it_ref + '"', 'test page' ) + '.'
        ])

        , centered_pic( 'sun' )





        , section_title_with_anchor( 'conclusion', 'Conclusion' )

        , hh.p([
            c_transfun + ' combines the best of two worlds: clarity and conciseness of functional syntax:'
        ])
        , js_pre_code([
            "var appfun = tfun.map( '.p' ).filter( '!=null' ).redinit( '0', '+' );",
            "var result = appfun( arr );"
        ])
        
        , hh.p([
            '...with, ' + hh( 'a href="#motor"', 'under the hood' ) 
            , ', high speed imperative code, automatically generated:'
        ])
        , js_pre_code( tfun.map( '.p' ).filter( '!=null' ).reduce( '+' ).getBodyCode() )

        , highlight( 'Future work' )

        , hh.p([
            'At the moment, I see two interesting directions: '
            , hh( 'span class="done"', 'parallelism' )
            , '&nbsp;(' + hh( 'a href="' + parallel_example_ref + '"', 'done' ) + ')'
            , ' and tail calls.'
            , ' If you have other suggestions, feel free to drop me a note:&nbsp;'
            , hh( 'a href="../email.jpg" title="email" alt="email"'
                  , hh( 'img src="../images/email_icon.png" class="email_icon"' )
                )
            , ' or &rarr;&nbsp;' + hh( 'a href="' + github_ref + '"', 'GitHub' )
               , '.'
        ])

        , highlight( 'Comparison with stream-based approaches' )

        , hh.p([
            '...in the corresponding '
            , hh( 'a href="#compare-with-stream"', 'Annex' )
            , '.'
        ])
        


        , section_hr()

        , section_title_with_anchor( 'license' , 'License' )

        , hh.p( 'The ' + c_transfun + ' code has the Boost License:' )

        // object did not have a stable CSS formatting (scrollbar randomly showing up)
        , hh( 'iframe name="license" type="text/plain" data="LICENSE" src="LICENSE" class="license"' )
        






        , section_hr()







        , centered_pic( 'naming' )


        , section_title_with_anchor( 'naming', next_annex_name() + ': Transformations vs. applications' )

        , hh.p([
            , c_transfun + ' involves 2 sorts of functions: "transformation" and "application".'
        ])

        , highlight( 'Transformation function' )
        , js_pre_code( "tfun.map  // transfun( <string> ) => <appfun>")
        , hh.p([ c_m + ' takes an expression string,'
                 , ' and returns an application ' + hh.em( 'function' )
                 , '.'
               ])

        , highlight( 'Application function' )
        , js_pre_code( "var appfun = tfun.map( '.p' );  // appfun( <array> ) => <array>" )
        , hh.p([ hh.code( "appfun" )
                 , ' is a function that takes an array ' + hh.em( 'value' )
                 , ' &amp; returns another array '
                 , hh.em( 'value' ) + '.'
               ])






        , centered_pic( 'chaining' )

        , section_title_with_anchor( 'chaining', next_annex_name() + ': Chaining' )

        , hh.p([
            'JavaScript functions are also objects. '
            , c_transfun + ' uses that to offer chaining methods '
            , 'on application functions: '
        ])

        , js_pre_code([
            'tfun.map                            // transfun: <string> => <appfun>',
            "tfun.map( '.p' )                    // appfun:   <array>  => <array>",
            "tfun.map( '.p' ).filter             // transfun (chaining)",
            "tfun.map( '.p' ).filter( '!=null' ) // appfun",
            "etc."
        ])
        
        , hh.p([
            'Application functions methods are (a)&nbsp;'
            , hh( 'a href="#defining"', 'published' )
            , ' transfuns and (b)&nbsp;one special method called ' + c_next + ': '
        ])

        , hh.p( [
            js_code( 'appfun.next(...)' ) + ' chains with existing appfuns:' 
        ])
        
        , js_pre_code([
            "var sumAppfun = tfun.reduce('+');",
            "// ...",
            "var otherAppfun = tfun.map('.p').filter('!=null').next(sumAppfun);",
            "// ...",
            "var result = otherAppfun([{p:123},{p:null},{p:1000}]);",
            "// result === 1123"
        ])
        




        , centered_pic( 'dryingthewalls' )

        , section_title_with_anchor( 'defining', next_annex_name() + ': Defining transformations' )

        , hh.p([
            'Published or private transformations can be defined:'
        ])
        , js_pre_code([
            '// "Published": In tfun.<name> namespace',
            'tpub( <name:string>, <definition:object> );',
            '',
            '// "Private": In local namespace',
            'var myTransfun = tfun( <definition:object> );'
        ])
        
        , highlight( 'Example: ' + js_code( 'tfun.map' ) )

        , hh.p([ 
            'For example, ' + hh.code( 'tfun.map' ) + ' is created and published as follows:' 
        ])

        , js_pre_code([
            
            "tpub( 'map', {",
            "    arity    : 1",
            "    , specgen: function ( /*string | externcall object*/transform ) {",
            "        return { loopleftright: {",
            "            morph: 'array'",
            "            , conserve_array_length: true",
            "            , bodyadd: { set: [ 'v',",
            "                                fullexpr( transform, 'v', 'k' ) ] }",
            "        }};",
            "    }",
            "});"
        ])

        , hh.p([
            '...which describes the characteristics of ' + c_m + ' ' +
                hh.em( 'without' ) + ' writing a ' + hh.code( 'for' ) + ' loop:'
        ])

        , hh.dl([
            dl_describe(
                hh.code( 'arity' )
                , ' is the number of parameters of ' + hh.code( 'specgen' )
            )
            , dl_describe(
                hh.code( 'loopleftright' )
                , ' means: "loop through an array from 1st to last element"' 
            )
            , dl_describe(
                hh.code( "morph: 'array'" ) 
                , ' means: "transform an array into another array"' 
            )
            , dl_describe( 
                hh.code( 'conserve_array_length: true' ) 
                , ' means: just what it says!' 
            )
            , dl_describe(
                hh.code( 'bodyadd' )
                , ' describes what to do inside the loop.' 
            )
        ])

        , hh.p([
            '...and ' + hh.code( "fullexpr( transform, 'v', 'k' )" ) + ' completes the expression ' +
                hh.code( 'transform' ) + ' if needed, using ' + hh.code( 'v' ) + ' on the left, and ' + hh.code( 'k' ) + ' on the right. ' +
                'So writing:'
        ])
        , js_pre_code( "tfun.map('.p')")
        , hh.p('is equivalent to write:')
        , js_pre_code( "tfun.map('v.p')" )
        , hh.p( 'Both work. Moreover, function arguments are also accepted:' )
        , js_pre_code( "tfun.map((x)=>x.p)" )
        , hh.p([
            '...but lead to a performance loss. For a longer discussion about '
            , 'function arguments, please refer to the Section:&nbsp;'
            , hh( 'a href="#with-functions"'
                  , 'Usage with function arguments' )
            , '.'
        ])
        
        , highlight( 'Example: ' + js_code( 'tfun.filter' ) )

        , hh.p([
            'The definition of ' + hh.code( 'filter' ) + ' has a similar structure, except that it does not ' + hh.code( 'conserve_array_length' ) + ':'
        ])
        , js_pre_code([
            "tpub( 'filter', {",
            "    arity    : 1",
            "    , specgen: function ( /*string | externcall object*/test ) {",
            "        return { loopleftright: {",
            "            morph    : 'array'",
            "            , bodyadd: { restwrap: {",
            "                  'if': fullexpr( test, 'v', 'k' ),",
            "                  'then': { rest : 1 } } }",
            "        }};",
            "    }",
            "});"
        ])
        , hh.p([
            'The construct ' + js_code( '{ restwrap : { if : ..., then : { rest : 1 } } }' ) +
                ' wraps ' + hh.em( 'whatever' ) + ' future steps the body of the loop will have,' +
                ' inside an if/then branch.'
        ])
        , hh.p([
            hh.code( "fullexpr( test, 'v', 'k' )" ) + ' completes the expression ' +
                hh.code( 'test' ) + ' if needed, using ' + hh.code( 'v' ) + ' on the left, and ' + hh.code( 'k' ) + ' on the right. ' +
                'So writing:'
        ])
        , js_pre_code( "tfun.filter('!=null')")
        , hh.p('is equivalent to write:')
        , js_pre_code( "tfun.filter('v!=null')" )            
        , hh.p( 'Both work. Moreover, function arguments are also ' +  hh( 'a href="#with-functions"', 'accepted' ) + ':' )
        , js_pre_code( "tfun.filter((x)=>x!=null)" )


        , highlight( 'Example: ' + js_code( 'tfun.redinit' ) )

        , hh.p([
            hh.code( 'tfun.redinit' ) + ' is also a '
            , hh.code( 'loopleftright' ) + ', but does *not* morph into an array, because it&nbsp;produces a value '
            , hh.code( 'out' ) + ' of unknown type:'
        ])

        , js_pre_code([
            "tpub( 'redinit', {",
            "    arity: 2",
            "    , specgen: function ( /*string*/redinit, ",
            "                           /*string | externcall object*/combine ) {",
            "        return { loopleftright: {",
            "            beforeloop : { decl: [ 'out', ",
            "                                   fullexpr( redinit, 'current' ) ] }",
            "            , bodyadd  : { set: [ 'out', ",
            "                                  fullexpr( combine, 'out', 'v' ) ] }",
            "            , afterloop: { set: [ 'current', 'out' ] }",
            "        }};",
            "    }",
            "});",
        ])
        , hh.p( 'When called with parameters, the transformations ' + c_mfr + 
                ' are resolved and merged whenever possible, as described in the next section.' 
              )





        , centered_pic( 'underthehood' )


        , section_title_with_anchor( 'motor', next_annex_name() + ': Under the hood: merging loops' )
        , hh.p( 'The call:' )
        , js_pre_code( "tfun.map( '.p' ).filter( '!=null' ).redinit( '0', '+' )" )
        , hh.p( 'is implemented with: (1)&nbsp;resolution, (2)&nbsp;merging and (3)&nbsp;JavaScript code generation.' )

        , highlight( '(1) resolution' )
        , hh.p( 'An array of three specification objects is constructed:')
        , js_pre_code([
            '[',
            "    { loopleftright: {",
            "        morph: 'array'",
            "        , conserve_array_length: true",
            "        , bodyadd: { set: [ 'v', 'v.p' ] }",
            "    }},",
            "    ",
            "    { loopleftright: {",
            "        morph    : 'array'",
            "        , bodyadd: { restwrap: { 'if': 'v!=null',",
            "                                  'then': { rest : 1 } } }",
            "    }},",
            "    ",
            "    { loopleftright: {",
            "        beforeloop : { decl: [ 'out', '0' ] }",
            "        , bodyadd  : { set: [ 'out', 'out+v' }",
            "        , afterloop: { set: [ 'current', 'out' ] }",
            "    }}",
            "",
            "]"
        ])

        , highlight( '(2) merging' )
        , hh.p( 'Whenever we have:' )
        , hh.ul([
            hh.li( 'N consecutive objects describing loops of the same type, (here&nbsp;' + hh.code( 'loopleftright' ) + '),' )
            , hh.li( 'AND at least the first N-1 loops are morph loops of the same type, (here&nbsp;' + hh.code( 'morph: array' ) + '),' )
        ])
        , hh.p( '...then we merge them into a single specification object, describing a single loop:' )
        , js_pre_code([
            '[',
            "    { loopleftright: {",
            "        beforeloop : { decl: [ 'out', '0' ]",
            "        , bodyadd: [ { set: [ 'v', 'v.p' ] },",
            "                     { restwrap: { 'if': 'v!=null',",
            "                                   'then': { rest : 1 } } },",
            "                     { set: [ 'out', 'out+v' ] }",
            "                   ]",
            "        , afterloop: { set: [ 'current', 'out' ] }",
            "    }},",
            "]"
        ])

        , highlight( '(3) JavaScript code generation' )

        , hh.p( '...is done after unwrapping:' )
        , js_pre_code([
            "        , bodyadd: [ { set: [ 'v', 'v.p' ] },",
            "                     { restwrap: { 'if': 'v!=null',",
            "                                   'then': { rest : 1 } } },",
            "                     { set: [ 'out', 'out+v' ] }",
            "                   ]",
        ])
        , hh.p( '...into:' )
        , js_pre_code([
            "        , bodyadd: [ { set: [ 'v', 'v.p' ] },",
            "                     { 'if': 'v!=null',",
            "                       'then': { set: [ 'out', 'out+v' ] } }",
            "                   ]",
        ])
        , hh.p( 'Now ' + c_transfun + ' generates the JavaScript code:' )
        , js_pre_code( tfun.map('.p').filter('!=null').redinit('0','+').getBodyCode())
        , legend(
            'Internal code generated by ' + c_transfun
                + hh('br') + '(generated while this article loaded)'
        )

        



        , centered_pic( 'tim1bitadder' )

        , section_title_with_anchor( 'other-expl', next_annex_name() + ': Other examples' )
        
        , hh.p( 'Existing transformations can be combined to define application functions:' )
        , js_pre_code([
            "// Published: In tfun.* namespace",
            "tpub( 'sum', tfun.redinit( '0', '+' ) );",
            "",
            "// Private: In local namespace",
            "var sumAppfun = tfun( redinit( '0', '+' ) );",
            "// or simply:",
            "var sumAppfun = tfun.redinit( '0', '+' );"
        ])
        

        , hh.p( 'Simple, non-loop transformations can also be defined using the construct ' + hh.code( '{ stepadd : ... }' ) )
        , js_pre_code([ 
            "// Published: In tfun.* namespace",
            "tpub( 'join', {",
            "    arity : 1,",
            "    specgen : function ( s ) { return {",
            "        stepadd: { set : [ 'current', 'current.join(' + s + ')' ] }",
            "    }",
            "});",
            "",
            "// Private: In local namespace",
            "var joinAppfun = tfun( { arity : 1, ... } );"
        ])
        , hh.p( 'For such cases, a shortcut syntax is available:')
        , js_pre_code([

            "// Published: In tfun.* namespace",
            "tpub( 'join', '#s',  '.join(#s)' );",
            "",
            "// Private: In local namespace",
            "var joinAppfun = tfun( '#s', '.join(#s)' );"
        ])
        , hh.p([ 'There are more examples on the &rarr;&nbsp;'
                 , hh( 'a href="' + test_ref + '"', 'test page' ) + '.'
               ])







        , centered_pic( 'streams' )


        , section_title_with_anchor( 'compare-with-stream', next_annex_name() + ': Comparison with stream-based approaches' )

        , hh.p([

            hh( 'a href="' + wu_ref + '"', c_wu )
            , ' and '
            , hh( 'a href="' + lazy_ref + '"', c_lazy )
            , ' are stream-based libraries that compare to '
            , c_transfun
            , ' as follows:'
        ])

        , hh.table([
            th_row( [ 'Feature', c_wu, c_lazy, c_transfun ] )
            , tr_rows([ 
                comp_table_sep
                ,[ 'takes stream input',                    sp_yes, sp_yes, sp_no ]
                ,[ 'takes array input',                     sp_yes, sp_yes, sp_yes ]
                ,[ 'takes object input',                    sp_no,  sp_no,  sp_yes ]
                ,comp_table_sep
                ,[ 'offers array &hArr; object conversion', sp_no, sp_no,  sp_yes ]
                ,[ 'lets the user define transformations',  sp_no, sp_no,  sp_yes ]
                ,comp_table_sep
                ,[ 'solves ' + hh( 'a href="#motivation"', 'performance issue' ) + ' #1 (calls)',   sp_no, sp_no,  sp_yes ]
                ,[ 'solves ' + hh( 'a href="#motivation"', 'performance issue' ) + ' #2 (arrays)',  sp_yes, sp_yes, sp_yes ]
                ,comp_table_sep
                ,[ 'implemented using ES6 generators',      sp_yes, sp_no,  sp_no  ]
                ,[ 'implemented using code generation',     sp_no,  sp_no,  sp_yes ]
                ,comp_table_sep
                ,[ 'separates data from application',       sp_no, sp_no, sp_yes ]
                ,[ 'offers parallelism (web workers)',      sp_no,  sp_no,  sp_yes ]
                ,comp_table_sep
            ])
        ])

        , hh.p([
            'The core difference is that ' + c_transfun + ' generates a single piece of code. '
            , ' This makes parallelism and performance analysis easy, as detailed below. '
        ])

        , hh.p([
            ' On the other hand, ' + c_transfun + ' does not support streams at the moment (February 2016).'
        ])

        /*
        , hh.p([
            'Of course things are not cast in stone: ' + c_wu + ' and ' + c_lazy + ' might offer parallelism '
            , 'someday ; ' + c_transfun + ' might support streams someday.'
        ])
        */

        , highlight( 'Parallelism with ' + c_transfun + ': web workers' )

        , hh.p([
            'This is an array-only feature, requiring the '
            , c_parallel + ' plugin'
            , ', which runs an ' + c_appfun + ' in parallel, using 1, some or all of the available other CPU cores: '
            , hh( 'a href="' + parallel_example_ref + '"', 'Example of use' )
            , ',&nbsp; '
            , hh( 'a href="' + parallel_ref + '"', 'plugin source code' )
            , '.'
        ])
        
        , highlight( 'Performance analysis with ' + c_transfun )

        , hh.p([
            'Let us say that some profiling is pointing at the following line being called very often: '
        ])
        
        , js_pre_code([
            "// ...",
            "var result = appfun( data );  // <<< here",
            "// ..."
        ])

        , hh.p([ 'To make sure to get the best possible performance, we can easily look at the generated code:' ])

        , js_pre_code([
            "appfun.getBodyCode()",
            "// for example",
            "//     tfun.map( '.p' ).filter( '!=null' ).reduce( '+' ).getBodyCode()",
            "// returns:",
            tfun.map( '.p' ).filter( '!=null' ).reduce( '+' ).getBodyCode()
        ])

        , hh.p([ 'in that case we could scratch a little speedup by switching to ' + js_code( 'redinit()' ) + ':' ])

        , js_pre_code([
            "tfun.map( '.p' ).filter( '!=null' ).redinit( '0', '+' ).getBodyCode()",
            "// returns:",
            tfun.map( '.p' ).filter( '!=null' ).redinit( '0', '+' ).getBodyCode()
        ])

        , hh.p([
            'Debugging might be easier with ' + hh.em( 'one' ) + ' piece of generated code, '
            , 'as compared to the inherently distributed implementation of the stream-based approaches.'
        ])











        , section_title_with_anchor( 'annex-related-topics', next_annex_name() + ': Related topics' )

        , hh.p([ 'I received very interesting feedback, especially on '
                 , hh.code( 'comp.lang.javascript' )
                 , '.'
               ])

        , highlight( 'Getting rid of variables (when possible)' )

        , hh.blockquote([
            'Side note about lambdas: it would be nice to be able to write some '
            , 'without variables at all. OCaml has an interesting notation where one '
            , 'can wrap an operator + into a function (+)'
        ])

        , hh.p([ 'Haskell has that too, and it came (at least in the case of Haskell), '
                , 'from Miranda designed by David Turner.  He may have got it from a 1973 '
                , 'dissertation by Wile and (like so many such things) it probably has even '
                , 'older roots in mathematical logic.'
              ])

        , hh.p([ 'Haskell (and Miranda) can go both ways.  (+) is a function make from an '
                , 'operator, but given a function like mod, you can make an operator from '
                , 'it using `...`: '
              ])

        , hh.pre( hh.code( '95 `mod` 10' ) )
        
        , hh.p([ 'is 5.  And you can combine the two.  Since operators permit sections '
                , 'using either operand it can be handy to write (`mod` 10) for the "modulo 10" function.'
              ])

        , hh.p( '-- ')
        , hh.p( 'Ben.' )

        , highlight( 'Oliver Steele\'s Functional JavaScript' )

        , hh.p([ 'The original documentation page seems to be offline, but the code '
                 , 'is on '
                 , hh( 'a href="https://github.com/osteele/functional-javascript"'
                       , 'GitHub'
                       )
                 , ' and there is an '
                 , hh( 'a href="https://github.com/osteele/functional-javascript"'
                       , 'initial announcement'
                       )
                 , '.'
               ])

        , highlight( 'Transducers' )

        , hh.p([
            'First discussed in the Clojure community, e.g. '
            , hh( 'a href="http://blog.cognitect.com/blog/2014/8/6/transducers-are-coming"'
                  , 'Transducers are coming'
                  )
            , '. There are several well-known Javascript versions, including '
            , hh( 'a href="https://github.com/jlongster/transducers.js"'
                  , 'jlongster/transducers.js'
                )
            , ' and '
            , hh( 'a href="https://github.com/cognitect-labs/transducers-js"'
                  , 'cognitect-labs/transducers-js'
                )
            , '.  They\'re also partially folded into some more general-purpose libraries like '
            , hh( 'a href="http://ramdajs.com"'
                  , 'Ramda'
                )
            , ' (disclosure: I\'m one of the authors.)'
        ])
        , hh.p([ '-- Scott' ])
        
        , highlight( 'Trine: functional programming using the :: bind operator' )

        , hh.blockquote([ 'Ramda argues that lodash and underscore put the data in the wrong place: at the first parameter of the function, while it should be at the last position. They\'re both (subjectively) wrong: the natural place for data in JS is the '
                          , hh.code( 'this' )
                          , ' parameter.'
                        ])
        
        , hh.p([ '&rarr;&nbsp;'
                 , hh( 'a href="https://github.com/jussi-kalliokoski/trine"'
                     , 'jussi-kalliokoski/trine' )
               ])

        , highlight( 'Fold-fusion laws' )

        , hh.p([ '&rarr;&nbsp;'
                 , tautolink( 'http://www.cs.nott.ac.uk/~pszgmh/fold.pdf' )
               ])
        
        , hh.p( '&rarr;&nbsp;'
                 , tautolink( 'https://www.cs.ox.ac.uk/ralf.hinze/publications/IFL10.pdf' )
               )

        , hh.p([ 'Feedback from Michael Haufe (TNO).' ])

    ].join( '\n' ));  

    gEBI( 'contents' ).innerHTML = hh.ul( st_arr.map( function ( o ) {
        return hh.li( hh( 'a href="#' + o.id + '"', o.text ) +
                      (o.id === 'unit-test'  ?  ' (' + hh( 'span id="result"' ) + ')'  :  '')
                    );
    }).join( '\n' ) );

    // Tool functions
    
    function tautolink( href )
    {
        return hh( 'a href="' + href + '"'
                 , href 
                 );
    }
    

    function dl_describe( dt, dd )
    {
        return [
            hh.dt( dt )
            , hh.dd( dd )
        ];
    }

    function highlight( s ) 
    {
        if ('string' !== typeof s)
            s = s.join( '' );

        var id = s.replace( /\W/g, '-' )
            .toLowerCase()
            .replace( /--+/g, '-' )
        ;

        return hh( 'p class="highlight" id="' + id + '"' , [
            hh.em( s ) 
            , ''
            , hh( 'span class="highlight-anchor"'
                  , [
                      '&nbsp;&nbsp;'
                      , hh( 'a href="#' + id + '"'
                            , '#'
                          )
                  ]
                )
        ] ); 
    }

    function js_pre_code( s )
    {
        return hh( 'pre class="prettyprint lang-js"', hh.code( (s.join ? s : [s]).map( hh.esc ).join( '\n' ) ) );
    }

    function js_code( s )
    {
        return hh( 'code class="prettyprint lang-js"', (s.join ? s : [s]).map( hh.esc ).join( '\n' ) );
    }

    function legend( s ) { return hh( 'p class="legend"', s ); }
    
    function section_hr() { return hh( 'hr class="section-hr"' ) + hh.hr(); }

    function section_title_with_anchor( id, text )
    {
        if ('string' !== typeof text)
            text = text.join( '' )

        if (id)
            st_arr.push( { id : id, text : text } );
        
        return hh( 'h3 id="' + id + '" class="section-title"'
                , text + '' +
                (!id  ?  ''  :  hh( 'span class="section-anchor"', '&nbsp;(' + hh( 'a href="#' + id + '"', '#' ) + ')' ))
              )
    }
    
    function th_row( arr )
    {
        return tval( arr )(
            tfun.map( 'hh( "th" + (k < 1 ? "" : " class=\'centered-cell\'"), v)' )
                .next( 'hh.tr(current)' )
        );
    }

    function tr_rows( arr )
    {
        var one_row_appfun = tfun.map( [
            'v.comp_table_sep'
            , '?'
            , 'hh( "td colspan=\'4\'", hh.hr() )'
            , ':'
            , 'hh( "td" + (k < 1 ? "" : " class=\'centered-cell\'"), v)'
        ].join( '  ' )).next( 'hh.tr(current)' )
        ;

        return tval( arr )(
            tfun.map( one_row_appfun ).join( '"\\n"' )
        )
        ;
    }
    
    function next_annex_name()
    {
        var c = next_annex_name.c;

        c = next_annex_name.c = c == null
            ?  'A'
            :  String.fromCharCode( 1 + c.charCodeAt( 0 ) )
        ;

        return 'Annex ' + c;
    }

    function centered_pic( name )
    {
        var x = ({

            alchemyequipment : {
                src     : 'rsrc_web/img/pic_alchemyequipment.gif'
                , title : 'alchemy equipment'
                , href  : 'http://www.levity.com/alchemy/images_s.html'
                , attr  : 'height="200px"'
            }

            , castlekids : {
                src     : 'rsrc_web/img/pic_castlekids.jpg'
                , title : 'kids building a castle'
                , href  : 'http://entertainmentdesigner.com/news/experiences/see-a-13th-century-castle-being-built-with-medieval-technology-in-treigny-france/'
            }

            , chaining : {
                src     : 'rsrc_web/img/pic_chaining.png'
                , title : 'chaining'
                , href  : 'http://freestyle.sourceforge.net/GALLERY/CHAINING/toruskno-t3d.php'
                , attr : 'width="200px"'
            }
            

            , dryingthewalls : {
                src     : 'rsrc_web/img/pic_dryingthewalls.gif'
                , title : 'Drying the walls - shot by Alexander Cohn'
                , href  : 'http://cohnphoto.photoshelter.com/gallery-image/Pilgrimage-to-Kawagarbo/G00006usB1sEBjXo/I00005w8Qih4U.ik'
            }
            
            , 'function' : {
                src     : 'rsrc_web/img/pic_function.png'
                , title : 'function'
                , href  : 'http://www.mathwarehouse.com/algebra/relation/evaluating-function.php'
                , attr  : 'height="200px"'
            }

            , mccreadygossamer : {
                src     : 'rsrc_web/img/pic_mccreadygossamer.jpg'
                , title : 'McCready\'s Gossamer Albatros - solving the right problem'
                , href  : 'http://www.afr.com/leadership/innovation/being-willing-to-fail-solved-the-problem-of-humanpowered-flight-20151016-gkb658'
                , attr  : 'width="333px"'
            }
            
            , naming : {
                src     : 'rsrc_web/img/pic_naming.jpg'
                , title : 'Naming is often hard...'
                , href  : 'http://www.nambos.de/en/naming-product-name-company-name.php'
                , attr  : 'width="250px"'
            }

            , oldcpu : {
                src     : 'rsrc_web/img/pic_oldcpu.jpg'
                , title : 'old CPU'
                , href  : 'http://arstechnica.com/civis/viewtopic.php?f=12&t=308172'
                , attr  : 'width="200px"'
            }

            
            , now_later : {
                src     : 'rsrc_web/img/pic_now_later.jpg'
                , title : 'Procrastinating'
                , href  : 'https://www.theodysseyonline.com/story-of-procrastination'
                , attr  : 'width="250px"'
            }

            , pipechair : {
                src     : 'rsrc_web/img/pic_pipechair.jpg'
                , title : 'Sewer pipe chair'
                , href  : 'https://www.google.com/search?site=&tbm=isch&source=hp&biw=1280&bih=929&q=pipe+order&oq=pipe+order&gs_l=img.3..0i8i30.547.1986.0.2069.10.10.0.0.0.0.111.875.9j1.10.0....0...1ac.1.64.img..0.10.873._USxC-CA36c#tbm=isch&q=pipe+sofa+&imgrc=mxR23v7hgEeSbM%3A'
                , attr  : 'width="250px"'
            }

            , streams : {
                src      : 'rsrc_web/img/pic_streams.jpg'
                , title  : 'Looking down - shot by Alexander Cohn'
                , href   : 'http://www.cohnphoto.com/#!/portfolio/G0000AwPsapVV6DE/I0000RqxjAZdfIQc'
                , attr   : 'height="300px"'
            }

            
            , sun : {
                src     : 'rsrc_web/img/pic_sun.jpg'
                , title : 'sun pic'
                , href  : 'http://thegraphicsfairy.com/vintage-clip-art-old-fashioned-sun-with-face/'
            }


            , tim1bitadder : {
                src     : 'rsrc_web/img/pic_tim1bitadder.png'
                , title : '1-bit adder with The Incredible Machine'
                , href  : 'https://www.youtube.com/watch?v=Vnke34fJr8k'
            }
            

            , toolbox : {
                src     : 'rsrc_web/img/pic_toolbox.jpg'
                , title : 'toolbox'
                , href  : 'http://westsideinternalmed.com/healthy-toolbox/'
                , attr  : 'width="250px"'
            }
            



            , underthehood : {
                src     : 'rsrc_web/img/pic_underthehood.jpg'
                , title : 'Corvette 1972'
                , href  : 'http://www.autotraderclassics.com/car-article/The+Big+Bang+Theory-80648.xhtml'
            }
            
        })[ name ]
        , tmp = x  &&  (x.title + (x.href  ?  ' (click: source)'  :  ''))
        ;

        return x
            ?  hh( 'p class="centered-pic"'
                   , (tmp = hh( 'img src="' + x.src + '" title="' + tmp + '" alt="' + tmp + '"' + (x.attr  ?  ' ' + x.attr :  '') )
                      , x.href  
                      ?  hh( 'a href="' + x.href + '" target="_blank"', tmp )  
                      :  tmp
                     )
                 )
        :  ''
        ;
    }

})();


    </script>

    <script type="text/javascript" src="rsrc_web/prettify/prettify.js"></script>
    <script type="text/javascript">setTimeout( prettyPrint );</script>

    <script type="text/javascript" src="rsrc_web/ga.js"></script>

  </body>
</html>
