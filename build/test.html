<!doctype html>
<!-- Copyright Guillaume Lathoud 2016
     Boost License: see the file ./LICENSE
-->
<html>
  <head>
    <meta charset=utf-8/>
    <title>transfun: tests</title>
    <link rel="stylesheet" type="text/css" href="rsrc_web/prettify/prettify.css"/>
    <style type="text/css">
      body { font-family: helvetica; }
      .section-anchor { font-size : 90%; font-decoration: none; }

      .license { width: 110%; height: 400px; border: none; margin: 0; paddin: 0; overflow: hidden; }
    </style>
    <script type="text/javascript" src="transfun.js"></script>
    <script type="text/javascript" src="plugin/devilappfun.js"></script>
    <script type="text/javascript" src="plugin/parallel.js"></script>
    <script type="text/javascript" src="test.js"></script>
    <script type="text/javascript" src="rsrc_web/opinel.js"></script>
  </head>
  <body>
    <script type="text/javascript">
var code_impl_transfun_redinit = "tfun.map( '.p' ).filter( '!=null' ).redinit( '0', '+' )"
,   code_impl_transfun_reduce  = "tfun.map( '.p' ).filter( '!=null' ).reduce( '+' )"
;

(function () {

    var st_arr = [];
    
    document.write(
        [
            hh.p( '&larr;&nbsp;' + hh( 'a href="./index.html"', 'Back to the article' ))

            , hh.h1( 'transfun: tests' )

            , section_title_with_anchor( '', 'Contents' )
            , hh( 'p id="contents"' )
            
            , hh.hr()
            , section_title_with_anchor( 'gen-code-expl', 'Generated code: examples' )
            , hh.pre( hh( 'code id="gen-code-expl-code" class="prettyprint lang-js"', ' ' ) )

            , hh.hr()
            , section_title_with_anchor( 'speed-test', 'Speed test: Run it!' )
            , hh.p( 'Similar to: ' +
                    hh( 'a target="_blank" href="http://jsperf.com/arr-map-filter-reduce/4"'
                        , 'http://jsperf.com/arr-map-filter-reduce/4'
                      )
                  )
            , hh.p( 'with additionally:' )
            , hh.pre( hh.ul([
                hh.li( hh.code( "transfun_redinit = " + code_impl_transfun_redinit ) )
                , hh.li( hh.code( "transfun_reduce  = " + code_impl_transfun_reduce ) )
            ]))

            , hh( 'button id="speed-test-start" style="display: none"', 'Start!' )
            , hh( 'div id="spt-out-cont" style="display: none;"'
                  , hh.pre( hh( 'code id="speed-test-useragent"', navigator.userAgent ) ) + 
                  hh.pre( hh( 'code id="speed-test-result"', ' ' ) )
                )

            , hh.hr()
            , section_title_with_anchor( 'example-speed-test-result', 'Speed test: Example results' )
            , hh( 'div id="estr-data-cont"' )
            

            , hh.hr()
            , section_title_with_anchor( 'parallel-speed-test', 'Parallel speed test: Run it!' )
            , hh.pre( hh( 'code class="prettyprint lang-js"'
                          , [
                              "parallel_appfun = tfun",
                              "  .declIn( { _count : '0', _inw_t_begin : 'Date.now()' } )",
                              "  .map( '.p' )",
                              "  .filter( '!=null' )",
                              "  .redinit( '0', '_count++, out+v' )",
                              "  .next( '{ sum : current, count : _count, max_inw_dur_ms : Date.now() - _inw_t_begin }' )",
                              ";"
                          ].join( '\n' )
                        ))
            
            , hh.p([ '...on arrays of data with increasing sizes.' ])

            , hh.p([ 'As of February 2016, most of the time is spent in communication overhead - directly proportional to the array size. ' ])
            
            , hh.p([ ' In the future, big *numerical* data could be passed with SharedArrayBuffer:' ])
            , hh.p([ hh( 'a href="https://blog.mozilla.org/javascript/2015/02/26/the-path-to-parallel-javascript/"' 
                           , 'https://blog.mozilla.org/javascript/2015/02/26/the-path-to-parallel-javascript/' ) 
                   ])
            , hh.p([ hh( 'a href="https://www.chromestatus.com/feature/4570991992766464"'
                         , 'https://www.chromestatus.com/feature/4570991992766464' )
                   ])

            , hh.p([ hh( 'a href="https://gist.github.com/dherman/5463054"' 
                         , 'https://gist.github.com/dherman/5463054'
                       )])

            , hh.p([ hh( 'a href="https://code.google.com/p/chromium/issues/detail?id=497295"'
                         , 'https://code.google.com/p/chromium/issues/detail?id=497295'
                       )])


            , hh.p([ hh( 'a href="https://bugs.chromium.org/p/v8/issues/detail?id=4614"'
                         , 'https://bugs.chromium.org/p/v8/issues/detail?id=4614'
                       )])

            , hh.p([ hh( 'a href="https://code.google.com/p/chromium/issues/detail?id=569681"'
                         , 'https://code.google.com/p/chromium/issues/detail?id=569681'
                       )])




            , hh.p([
                'For now (February 2016) it might be reasonable to restrict the use of web workers to '
                , ' CPU-intensive tasks that require little data, e.g. an intensive search '
                , 'of a solution in a large space of possibilities. Or split the data and pass it '
                , 'to the corresponding workers using '
                , hh( 'a href="https://developer.mozilla.org/en-US/docs/Web/API/Transferable"'
                      , 'Transferables' )
                , '.'
            ])


            , hh.p([
                'So this example here is currently a *bad* usage example, but at the same time a good way to measure the communication overhead with Web Workers.'
            ])

            , hh.p([
                'March 2016: Reduced the serialization overhead a lot (10-15 times) '
                , ' using ', hh( 'code class="prettyprint lang-js"', 'JSON.stringify' )
                , ' and ', hh( 'code class="prettyprint lang-js"', 'JSON.parse' )
                , '. Still not fast enough to make parallel processing of complex objects interesting - i.e. objects other than Transferables/TypedArrays. '
            ])

            , hh( 'button id ="parallel-speed-test-start" disabled="disabled"', 'Waiting for async unit tests to complete...' )
            , hh( 'div id="pspt-out-cont" style="display: none;"'
                  , hh.pre( hh( 'code id="parallel-speed-test-useragent"', navigator.userAgent ) ) + 
                  hh.pre( hh( 'code id="parallel-speed-test-result"', ' ' ) )
                )


            , hh.hr()
            , section_title_with_anchor( 'example-parallel-speed-test-result', 'Parallel speed test: Example results' )
            , hh( 'div id="epstr-data-cont"'
                  , hh.pre( hh( 'code class="prettyprint lang-js"', [ 
                      'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Ubuntu Chromium/48.0.2564.116 Chrome/48.0.2564.116 Safari/537.36\n\n',
                      JSON.stringify( [
                          {
                              "size": 1,
                              "nw2speed": [
                                  {
                                      "n_worker": 0,
                                      "data_len": 1,
                                      "dur_ms": 1,
                                      "ops_per_sec": 1000
                                  },
                                  {
                                      "n_worker": 1,
                                      "data_len": 1,
                                      "dur_ms": 4,
                                      "ops_per_sec": 250,
                                      "max_inw_dur_ms": 0,
                                      "overhead_dur_ms": 4
                                  },
                                  {
                                      "n_worker": 2,
                                      "data_len": 1,
                                      "dur_ms": 2,
                                      "ops_per_sec": 500,
                                      "max_inw_dur_ms": 0,
                                      "overhead_dur_ms": 2
                                  },
                                  {
                                      "n_worker": 3,
                                      "data_len": 1,
                                      "dur_ms": 2,
                                      "ops_per_sec": 500,
                                      "max_inw_dur_ms": 0,
                                      "overhead_dur_ms": 2
                                  }
                              ]
                          },
                          {
                              "size": 10,
                              "nw2speed": [
                                  {
                                      "n_worker": 0,
                                      "data_len": 10,
                                      "dur_ms": 1,
                                      "ops_per_sec": 1000
                                  },
                                  {
                                      "n_worker": 1,
                                      "data_len": 10,
                                      "dur_ms": 2,
                                      "ops_per_sec": 500,
                                      "max_inw_dur_ms": 0,
                                      "overhead_dur_ms": 2
                                  },
                                  {
                                      "n_worker": 2,
                                      "data_len": 10,
                                      "dur_ms": 3,
                                      "ops_per_sec": 333.3333333333333,
                                      "max_inw_dur_ms": 0,
                                      "overhead_dur_ms": 3
                                  },
                                  {
                                      "n_worker": 3,
                                      "data_len": 10,
                                      "dur_ms": 3,
                                      "ops_per_sec": 333.3333333333333,
                                      "max_inw_dur_ms": 0,
                                      "overhead_dur_ms": 3
                                  }
                              ]
                          },
                          {
                              "size": 100,
                              "nw2speed": [
                                  {
                                      "n_worker": 0,
                                      "data_len": 100,
                                      "dur_ms": 0,
                                      "ops_per_sec": null
                                  },
                                  {
                                      "n_worker": 1,
                                      "data_len": 100,
                                      "dur_ms": 2,
                                      "ops_per_sec": 500,
                                      "max_inw_dur_ms": 0,
                                      "overhead_dur_ms": 2
                                  },
                                  {
                                      "n_worker": 2,
                                      "data_len": 100,
                                      "dur_ms": 3,
                                      "ops_per_sec": 333.3333333333333,
                                      "max_inw_dur_ms": 0,
                                      "overhead_dur_ms": 3
                                  },
                                  {
                                      "n_worker": 3,
                                      "data_len": 100,
                                      "dur_ms": 1,
                                      "ops_per_sec": 1000,
                                      "max_inw_dur_ms": 0,
                                      "overhead_dur_ms": 1
                                  }
                              ]
                          },
                          {
                              "size": 1000,
                              "nw2speed": [
                                  {
                                      "n_worker": 0,
                                      "data_len": 1000,
                                      "dur_ms": 0,
                                      "ops_per_sec": null
                                  },
                                  {
                                      "n_worker": 1,
                                      "data_len": 1000,
                                      "dur_ms": 2,
                                      "ops_per_sec": 500,
                                      "max_inw_dur_ms": 0,
                                      "overhead_dur_ms": 2
                                  },
                                  {
                                      "n_worker": 2,
                                      "data_len": 1000,
                                      "dur_ms": 2,
                                      "ops_per_sec": 500,
                                      "max_inw_dur_ms": 0,
                                      "overhead_dur_ms": 2
                                  },
                                  {
                                      "n_worker": 3,
                                      "data_len": 1000,
                                      "dur_ms": 2,
                                      "ops_per_sec": 500,
                                      "max_inw_dur_ms": 0,
                                      "overhead_dur_ms": 2
                                  }
                              ]
                          },
                          {
                              "size": 10000,
                              "nw2speed": [
                                  {
                                      "n_worker": 0,
                                      "data_len": 10000,
                                      "dur_ms": 0,
                                      "ops_per_sec": null
                                  },
                                  {
                                      "n_worker": 1,
                                      "data_len": 10000,
                                      "dur_ms": 20,
                                      "ops_per_sec": 50,
                                      "max_inw_dur_ms": 0,
                                      "overhead_dur_ms": 20
                                  },
                                  {
                                      "n_worker": 2,
                                      "data_len": 10000,
                                      "dur_ms": 15,
                                      "ops_per_sec": 66.66666666666667,
                                      "max_inw_dur_ms": 0,
                                      "overhead_dur_ms": 15
                                  },
                                  {
                                      "n_worker": 3,
                                      "data_len": 10000,
                                      "dur_ms": 15,
                                      "ops_per_sec": 66.66666666666667,
                                      "max_inw_dur_ms": 0,
                                      "overhead_dur_ms": 15
                                  }
                              ]
                          },
                          {
                              "size": 100000,
                              "nw2speed": [
                                  {
                                      "n_worker": 0,
                                      "data_len": 100000,
                                      "dur_ms": 3,
                                      "ops_per_sec": 333.3333333333333
                                  },
                                  {
                                      "n_worker": 1,
                                      "data_len": 100000,
                                      "dur_ms": 75,
                                      "ops_per_sec": 13.333333333333334,
                                      "max_inw_dur_ms": 3,
                                      "overhead_dur_ms": 72
                                  },
                                  {
                                      "n_worker": 2,
                                      "data_len": 100000,
                                      "dur_ms": 67,
                                      "ops_per_sec": 14.925373134328359,
                                      "max_inw_dur_ms": 2,
                                      "overhead_dur_ms": 65
                                  },
                                  {
                                      "n_worker": 3,
                                      "data_len": 100000,
                                      "dur_ms": 69,
                                      "ops_per_sec": 14.492753623188406,
                                      "max_inw_dur_ms": 2,
                                      "overhead_dur_ms": 67
                                  }
                              ]
                          },
                          {
                              "size": 1000000,
                              "nw2speed": [
                                  {
                                      "n_worker": 0,
                                      "data_len": 1000000,
                                      "dur_ms": 7,
                                      "ops_per_sec": 142.85714285714286
                                  },
                                  {
                                      "n_worker": 1,
                                      "data_len": 1000000,
                                      "dur_ms": 571,
                                      "ops_per_sec": 1.7513134851138354,
                                      "max_inw_dur_ms": 7,
                                      "overhead_dur_ms": 564
                                  },
                                  {
                                      "n_worker": 2,
                                      "data_len": 1000000,
                                      "dur_ms": 440,
                                      "ops_per_sec": 2.272727272727273,
                                      "max_inw_dur_ms": 5,
                                      "overhead_dur_ms": 435
                                  },
                                  {
                                      "n_worker": 3,
                                      "data_len": 1000000,
                                      "dur_ms": 516,
                                      "ops_per_sec": 1.937984496124031,
                                      "max_inw_dur_ms": 4,
                                      "overhead_dur_ms": 512
                                  }
                              ]
                          }
                      ]
                                      , null, 2)
                  ])))




            , hh( 'hr id="unit-test-hr"' )
            , section_title_with_anchor( 'unit-test', 'Unit tests' )
            , hh.pre( hh( 'code id="unit-test-code" class="prettyprint lang-js"', ' ' ) )

            , hh( 'hr id="async-unit-test-hr"' )
            , section_title_with_anchor( 'async-unit-test', 'Parallel web workers unit tests' )
            , hh.pre( hh( 'code id="async-unit-test-code" class="prettyprint lang-js"', '(should start soon)' ) )


            , hh.hr()
            , section_title_with_anchor( 'license' , 'License' )
            // object did not have a stable CSS formatting (scrollbar randomly showing up)
            , hh( 'iframe name="license" type="text/plain" data="LICENSE" src="LICENSE" class="license"' )

        ].join( '\n' )
    );

    gEBI( 'contents' ).innerHTML = hh.ul( st_arr.map( function ( o ) {
        return hh.li( hh( 'a href="#' + o.id + '"', o.text ) +
                      (o.id === 'unit-test'  ?  ' (' + hh( 'span id="result"' ) + ')' 
                       : o.id === 'async-unit-test'  ?  ' (' + hh( 'span id="async-result"', 'should start soon' ) + ') '
                       : '')
                    );
    }).join( '\n' ) );

    function section_title_with_anchor( id, text )
    {
        if (id)
            st_arr.push( { id : id, text : text } );
        
        return hh( 'h3 id="' + id + '"'
                   , text + '&nbsp;' +
                   (!id  ?  ''  :  hh( 'span class="section-anchor"', '(' + hh( 'a href="#' + id + '"', '#' ) + ')' ))
                 )
    }
})();
    </script>
    
    <pre id="estr-data" style="display: none"><code>-----
Chrome 47:  Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/47.0.2526.111 Safari/537.36

[transfun_redinit] speed:  31480 ops/sec  &ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;
[transfun_reduce]  speed:  30591 ops/sec  &ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;
[1loop]            speed:  31225 ops/sec  &ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;
[3loops]           speed:  11155 ops/sec  &ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;
[native]           speed:    410 ops/sec  &ndash;

[transfun_redinit] speed:  31167 ops/sec  &ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;
[transfun_reduce]  speed:  30647 ops/sec  &ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;
[1loop]            speed:  31485 ops/sec  &ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;
[3loops]           speed:  10874 ops/sec  &ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;
[native]           speed:    410 ops/sec  &ndash;

-----
Firefox 43:  Mozilla/5.0 (Windows NT 6.1; WOW64; rv:43.0) Gecko/20100101 Firefox/43.0

[transfun_redinit] speed:  51274 ops/sec  &ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;
[transfun_reduce]  speed:  39471 ops/sec  &ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;
[1loop]            speed:  53757 ops/sec  &ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;
[3loops]           speed:   6674 ops/sec  &ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;
[native]           speed:   2655 ops/sec  &ndash;&ndash;&ndash;

[transfun_redinit] speed:  44043 ops/sec  &ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;
[transfun_reduce]  speed:  33099 ops/sec  &ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;
[1loop]            speed:  42010 ops/sec  &ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;
[3loops]           speed:   7066 ops/sec  &ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;
[native]           speed:   2323 ops/sec  &ndash;&ndash;

-----
Internet Explorer 11:  Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; SLCC2; .NET CLR 2.0.50727; .NET CLR 3.5.30729; .NET CLR 3.0.30729; Media Center PC 6.0; .NET4.0C; InfoPath.3; .NET4.0E; rv:11.0) like Gecko

[transfun_redinit] speed:  35656 ops/sec  &ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;
[transfun_reduce]  speed:  26930 ops/sec  &ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;
[1loop]            speed:  33166 ops/sec  &ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;
[3loops]           speed:   4716 ops/sec  &ndash;&ndash;&ndash;&ndash;&ndash;
[native]           speed:   1651 ops/sec  &ndash;&ndash;

[transfun_redinit] speed:  35234 ops/sec  &ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;
[transfun_reduce]  speed:  26764 ops/sec  &ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;
[1loop]            speed:  32703 ops/sec  &ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;&ndash;
[3loops]           speed:   4733 ops/sec  &ndash;&ndash;&ndash;&ndash;&ndash;
[native]           speed:   1649 ops/sec  &ndash;&ndash;

</code></pre>
    <script type="text/javascript">
(function () {
    var dataNode = gEBI( 'estr-data' );
    gEBI( 'estr-data-cont' ).appendChild( dataNode );
    dataNode.style.display = '';
})();
    </script>

<script type="text/javascript">
    (function () {
        var success = false
        ,   printed = false
        ;
        setTimeout( print_result, 0 ); // in case of failure
        test();
        success = true;
        print_result();
        print_test_detail();
        print_gen_code_expl();
        setup_speed_test();
        
        function print_result()
        {
            if (!printed)
            {
                printed = true;
                gEBI( 'result' ).innerHTML = success  ?  'success' :  'failure';
            }
        }

        function print_test_detail()
        {
            gEBI( 'unit-test-code' ).textContent = test;
        }

        function print_gen_code_expl()
        {
            var f = tfun.map( function (v) {
                var dashes = tval( v )(
                    tfun
                        .split( '"\\n"' )
                        .redinit( '""'
                                  , 'out.length > v.length ? out : v'
                                )
                        .next( '.replace( /[\\s\\S]/g, "-" )' )
                )
                ;
                return  dashes + "\n" + v + '\n' + dashes + '\n' +
                    (new Function('return ' + v)()) + '\n'
            })
                .join( '"\\n\\n"' )
                .next( '.replace( /</g, "&lt;" )' )
            ;
            
            gEBI( 'gen-code-expl-code' ).innerHTML = f(
                [
                    "tfun.sorted('a-b')"
                    , "tfun.sorted( 'a[0]<b[0] ? -1 : +1' )"
                    , "tfun.map( '.p' ).filter( '!=null' ).redinit( '0', '+' )"

                    , "tfun.arg('a,b,c').next('a+b*c')"

                    , "tfun.range()"

                    , "tfun.rangeOf( 'a', 'b' )"

                    , "tfun.arg( 'arr,begin,end' ).rangeOf( 'begin', 'end' ).filter( 'v in arr' ).map( 'arr[ v ]' )"
                                        
                    , "tfun.split( '\"&\"' ).filter( '' ).map( '.split(\"=\")').filter( 'v[0]!=\"xyz\"' ).map( '.join(\"=\")' ).join( '\"&\"')"
                    , "tfun.split( '\"&\"' ).filter( '.split(\"=\")[0]!=\"xyz\"' ).join( '\"&\"')"

                    , "tfun.split( '\"&\"' ).filter( '!/^xyz=/.test(v)' ).join( '\"&\"')"

                    , "tfun.map( 'Math.log(v)' ).sum().next( 'Math.exp(current/n)' )"
                    , "tfun.decl( '_count', '0' ).filter( '!=null' ).map( '.age' ).redinit( '0', '_count++, out+v' ).next( '/_count' )"


                    , "tval( 'abcd\\nefghijkl\\nmnop' )( tfun.split( '\"\\\\n\"' ).redinit( '\"\"', 'out.length > v.length ? out : v' ).next( '.replace( /[\\\\s\\\\S]/g, \"*\" )' ) )"
                    , "tfun.split( '\"\\\\n\"' ).redinit( '\"\"', 'out.length > v.length ? out : v' ).next( '.replace( /[\\\\s\\\\S]/g, \"*\" )' )"                   

                    , "JSON.stringify( tval( [ { a: 1, b : 2 }, { a: 500, b : 600 }, { a : 30, b : 40 } ] )\n  ( tfun.declIn( { _a : '0', _b : '0' } ).each( '_a += v.a, _b += v.b' ).next( '{ a : _a, b : _b }' ) )\n, null\n, 2 )"
                    , "tfun.declIn( { _a : '0', _b : '0' } ).each( '_a += v.a, _b += v.b' ).next( '{ a : _a, b : _b }' )"
                    
                    , "JSON.stringify( tval( [ { a: 1, b : 2 }, { a: 500, b : 600 }, { a : 30, b : 40 } ] )( tfun.reduce( '{ a : out.a + v.a, b : out.b + v.b }' ) ), null, 2)"
                    , "tfun.reduce( '{ a : out.a + v.a, b : out.b + v.b }' )"
                    
                    , "JSON.stringify(  [ { a: 1, b : 2 }, { a: 500, b : 600 }, { a : 30, b : 40 } ].reduce( function (a,b) { return tval.call( a, b )( tfun.mapIn( 'v+this[k]' ) ); } ), null, 2)"
                    , "tfun.mapIn( 'v+this[k]' ).getBodyCode() // xxx think about zip-like stuff and/or loop-in-loop... or not"
                    
                    
                    , "'some/string*\"@cha\xEEne$de_caract\xE8res'.replace( /\\W/g, '-' )"
                    , "tval( 'some/string*\"@cha\xEEne$de_caract\xE8res' )( tfun.split( '\"\"' ).map( 'v.match(/\\\\w/) ? v : \"-\"' ).join( '\"\"' ) )"
                    , "tval( 'some/string*\"@cha\xEEne$de_caract\xE8res' )( tfun.split( '\"\"' ).each( 'if (!/\\\\w/.test(v)) current[k] = \"-\"' ).join( '\"\"' ) )"
                    , "tval( 'some/string*\"@cha\xEEne$de_caract\xE8res' )( tfun.split( '\"\"' ).each( { 'if' : '!/\\\\w/.test(v)', then : 'current[k] = \"-\"' } ).join( '\"\"' ) )"
                    , "tval( 'some/string*\"@cha\xEEne$de_caract\xE8res' )( tfun.split( '\"\"' ).each( { 'if' : '!/\\\\w/.test(v)', then : { set_at : [ 'current', 'k', '\"-\"' ] } } ).join( '\"\"' ) )"
                    
                    
                    , "tval( 'abc=123&xyz=456&def=qq' )( tfun.split( '\"&\"' ).filter( '' ).map( '.split(\"=\")').filter( 'v[0]!=\"xyz\"' ).map( '.join(\"=\")' ).join( '\"&\"') )"
                    , "tval( 'abc=123&xyz=456&def=qq' )( tfun.split( '\"&\"' ).filter( '.split(\"=\")[0]!=\"xyz\"' ).join( '\"&\"') )"
                    , "tval( 'abc=123&xyz=456&def=qq' )( tfun.split( '\"&\"' ).filter( '!/^xyz=/.test(v)' ).join( '\"&\"') )"
                    , "'abc=123&xyz=456&def=qq'.replace( /(?:^|&)xyz=[^&]*/g, '' )"


                    , "tfun.split( '\"\"' ).map( 'v.match(/\\\\w/) ? v : \"-\"' ).join( '\"\"' )"
                    , "tfun.split( '\"\"' ).each( 'if (!/\\\\w/.test(v)) current[k] = \"-\"' ).join( '\"\"' )"
                    , "tfun.split( '\"\"' ).each( { 'if' : '!/\\\\w/.test(v)', then : 'current[k] = \"-\"' } ).join( '\"\"' )"
                    , "tfun.split( '\"\"' ).each( { 'if' : '!/\\\\w/.test(v)', then : { set_at : [ 'current', 'k', '\"-\"' ] } } ).join( '\"\"' )"

                ]
            );
        }

        function setup_speed_test()
        {
            var sst_btn = gEBI( 'speed-test-start' )
            , orig_text = sst_btn.textContent

            , test_data
            , impl_transfun_reduce  = new Function( 'return ' + code_impl_transfun_reduce )()
            , impl_transfun_redinit = new Function( 'return ' + code_impl_transfun_redinit )()
            ;
            
            aEL( sst_btn, 'click', speed_test_start );
            sst_btn.style.display = '';

            function speed_test_start()
            {
                sA( sst_btn, 'disabled', 'disabled' );
                sst_btn.textContent = 'Running...';

                var node = gEBI( 'speed-test-result' );
                node.textContent = '\n' + node.textContent;

                gEBI( 'spt-out-cont' ).style.display = '';
                
                async_run( [
                    function ( notifyDone ) { test_data = create_pseudo_random_arr(); notifyDone(); } 
                    , function ( notifyDone ) { run_test( test_data, '[native]          ', impl_native, notifyDone ); }
                    , function ( notifyDone ) { run_test( test_data, '[3loops]          ', impl_3loops, notifyDone ); }
                    , function ( notifyDone ) { run_test( test_data, '[1loop]           ',  impl_1loop, notifyDone ); }
                    , function ( notifyDone ) { run_test( test_data, '[transfun_reduce] ',  impl_transfun_reduce, notifyDone ); }
                    , function ( notifyDone ) { run_test( test_data, '[transfun_redinit]', impl_transfun_redinit, notifyDone ); }
                    , speed_test_done
                ] );
            }

            function speed_test_done()
            {
                var node = gEBI( 'speed-test-result' );
                node.innerHTML = node.innerHTML.replace( /speed:\s*(\d+)[^\(]*(\([^\)]*\))/g, replace_sanity_check_with_speed_bar );
                
                sst_btn.textContent = orig_text;
                sst_btn.removeAttribute( 'disabled' );

                function replace_sanity_check_with_speed_bar( s, s_n, s_paren )
                {
                    var n = Math.max( 1, Math.round( parseFloat( s_n ) / 1000 ) );
                    return s.replace( s_paren, tfun.map( '"&ndash;"' ).join( '""' )( Array.apply( null, new Array( n ) ) ) );
                }
            }

            // --- Speed test details

            function impl_native( arr )
            {
                return arr.map(function(x) { return x.p; })
                    .filter(function(x) { return x != null; })
                    .reduce(function(a, b) { return a + b; })
                ;
            }

            function impl_3loops( arr )
            {
                var n = arr.length;
                
                // .map(".p")
                var tmp_1 = new Array(n);
                for (var i = 0; i < n; i++)
                    tmp_1[i] = arr[i].p;

                // .filter("!=null")
                var tmp_2 = [];
                for (var i = 0; i < n; i++) {
                    var v = tmp_1[i];
                    if (v != null)
                        tmp_2.push(v);
                }

                // .reduce("+")
                var sum = 0;
                for (var n2 = tmp_2.length, i = 0; i < n2; i++)
                    sum = sum + tmp_2[i];

                return sum;
            }

            function impl_1loop( arr )
            {
                var sum = 0,
                    n = arr.length;
                for (var i = 0; i < n; i++) {
                    var v = arr[i];
                    v = v.p; // .map(".p")
                    if (v != null) // .filter("!=null")
                        sum = sum + v; // .reduce("+")
                }
                return sum;
            }
            
        }

        // --- Tool functions
        
        function run_test( test_data, name, impl, notifyDone )
        {
            var current_n     = 1
            ,   real_duration = null
            , target_duration = 1000
            ;

            var out = impl( test_data );

            run_and_adjust();

            function run_and_adjust()
            {
                var begin = Date.now();

                for (var i = current_n; i--;)
                    impl( test_data );

                real_duration = Date.now() - begin;

                var ratio = real_duration / target_duration;

                if (0.9 < ratio  &&  ratio < 1.1)
                {
                    run_test_done();
                }
                else if (ratio < 0.5)
                {
                    // rough adjustment (typically at the beginnin)
                    current_n *= 2;
                    run_and_adjust();
                }
                else
                {
                    // fine adjustment (typically at the end)
                    current_n = Math.round( current_n / ratio );
                    setTimeout( run_and_adjust, 357 );
                }
            }
            
            function run_test_done()
            {
                var node  = gEBI( 'speed-test-result' );

                var speed = Math.round(1000 * current_n / real_duration)
                ,   s_str = '' + speed
                ;
                
                while (s_str.length < 6)
                    s_str = ' ' + s_str;
                
                node.textContent = [
                    , name + ' speed: ' + s_str + ' ops/sec  (sanity check: output value: ' + out + ')'
                ]
                    .join( '\n' )
                    + node.textContent  // reverse chronological order
                ;

                notifyDone();
            }
            
        }
        
    })();


function async_run( funarr )
{
    if (funarr.length > 0)
        setTimeout( async_next, 1234 );  // 1234: pause to let the browser breathe
    
    function async_next()
    {
        funarr[ 0 ]( notifyDone );  // funarr[ 0 ] might be itself async -> pass it a callback
    }
    
    function notifyDone()
    {
        async_run( funarr.slice( 1 ) );
    }
}
    </script>


    <script type="text/javascript">
// async unit tests (e.g. parallel web workers)
(function () {
    var detailnode = gEBI( 'async-unit-test-code' )
    ,      outnode = gEBI( 'async-result' )
    ;
    async_run_test( detailnode, outnode );
})();
    </script>


    <script type="text/javascript">
// parallel speed test
(function () {
    after_async( setup_parallel_speed_test );

    function setup_parallel_speed_test()
    {
        var psst_btn = gEBI( 'parallel-speed-test-start' )
        , orig_text = psst_btn.textContent
        ;
        
        aEL( psst_btn, 'click', parallel_speed_test_start );
        psst_btn.innerHTML = 'Run it!';
        rA( psst_btn, 'disabled' );
        psst_btn.style.display = '';
        
        var n_worker_max, speed_result_arr;
        function parallel_speed_test_start()
        {
            sA( psst_btn, 'disabled', 'disabled' );
            psst_btn.textContent = 'Running...';
            
            var node = gEBI( 'parallel-speed-test-result' );
            node.textContent = '\n' + node.textContent;
            
            gEBI( 'pspt-out-cont' ).style.display = '';
            
            speed_result_arr = [];

            async_run( [
                chose_n_worker_max
                , loop_through_test_array_sizes
                , parallel_speed_test_done
            ] );
        }

        function chose_n_worker_max( notifyDone )
        {
            var n_cores  = navigator.hardwareConcurrency  ||  8;  // xxx
            n_worker_max = n_cores - 1;
            notifyDone();
        }

        var parallel_appfun, merge_fun;
        var size, test_data, correct_result, one_speed_result;
        function loop_through_test_array_sizes( notifyDone )
        {
            var   array_sizes = [ 1, 10, 100, 1e3, 1e4, 1e5, 1e6 ]
            , max_array_size  = Math.max.apply( Math, array_sizes )
            , max_test_data   = create_pseudo_random_arr( max_array_size )
            ;
            
            parallel_appfun = tfun
                .declIn( { _count : '0', _inw_t_begin : 'Date.now()' } )
                .map( '.p' )
                .filter( '!=null' )
                .redinit( '0', '_count++, out+v' )
                .next( '{ sum : current, count : _count, max_inw_dur_ms : Date.now() - _inw_t_begin }' )
            
            merge_fun = function ( a, b )
            {
                return {
                    sum     : a.sum   + b.sum
                    , count : a.count + b.count
                    , max_inw_dur_ms : Math.max( a.max_inw_dur_ms, b.max_inw_dur_ms )
                };
            };

            next_size();

            // --- Details

            function next_size()
            {
                setTimeout( next_size_impl, 1000 );  // Let the browser breathe..
            }
            
            function next_size_impl()
            {
                if (!array_sizes.length)
                {
                    notifyDone();
                }
                else
                {
                    size      = array_sizes.shift();
                    test_data = max_test_data.slice( 0, size );
                    
                    loop_through_n_worker( next_size );
                }
            }
            
        }

        function loop_through_n_worker( notifyDone )
        {
            var n = 0;

            // First n=0: in the main process
            var t_begin = Date.now()
            ,   tmp     = tval( test_data )( parallel_appfun )
            ,   t_end   = Date.now()
            ;
            
            tmp = with_mean( tmp );
            correct_result = { sum : tmp.sum, count : tmp.count, mean : tmp.mean };

            var dur_ms = t_end - t_begin
            , nw2speed = [
                get_speed_obj( n, test_data.length, dur_ms )
            ]
            ;

            // Now with parallel processes
            speed_test_next_n_worker();
            
            // --- Details (function declarations)

            function with_mean( o )
            {
                var sum   = tmp.sum
                ,   count = tmp.count
                ;
                sum  .toPrecision.call.a;
                count.toPrecision.call.a;

                sum >= 0  ||  null.bug;
                count >= 0  ||  null.bug;

                var ret = Object.create( o );
                ret.mean = sum / count;
                return ret;
            }
            
            function get_speed_obj( n_worker, data_len, dur_ms )
            {
                return {
                    n_worker      : n_worker
                    , data_len    : data_len
                    , dur_ms      : dur_ms
                    , ops_per_sec : 1000 / dur_ms
                };
            }

            function speed_test_next_n_worker()
            {
                setTimeout( speed_test_next_n_worker_impl, 1234 );  // Let the browser breathe
            }
            
            function speed_test_next_n_worker_impl()
            {
                if (!(n < n_worker_max))
                {
                    speed_result_arr.push({
                        size : size
                        , nw2speed : nw2speed
                    });
                    notifyDone();
                }
                else
                {
                    n++;
                    
                    var t_begin = Date.now()

                    ,   tmp     = psplit( parallel_appfun, { n : n } )
                        .pmerge( merge_fun)
                        .next( with_mean )
                        .runOn( test_data )
                        .then( receive_result )
                    ;
                    function receive_result( r )
                    {
                        var t_end  = Date.now()
                        ,   dur_ms = t_end - t_begin
                        , max_inw_dur_ms = r.max_inw_dur_ms
                        ;
                        max_inw_dur_ms.toPrecision.call.a;
                        oEquals( correct_result, { sum : r.sum, count : r.count, mean : r.mean } )  ||  null.bug;

                        nw2speed[ n ] = get_speed_obj( n, test_data.length, dur_ms );
                        nw2speed[ n ].max_inw_dur_ms  = max_inw_dur_ms;
                        nw2speed[ n ].overhead_dur_ms = dur_ms - max_inw_dur_ms;

                        speed_test_next_n_worker();
                    }
                }
            }
            
        }

        function parallel_speed_test_done()
        {
            console.log('parallel_speed_test_done', speed_result_arr);

            var node = gEBI( 'parallel-speed-test-result' );
            node.innerHTML += '\n' + JSON.stringify( speed_result_arr, null, 2 );
            
            psst_btn.textContent = orig_text;
            psst_btn.removeAttribute( 'disabled' );
        }
    }

})();
    </script>

    <script type="text/javascript" src="rsrc_web/prettify/prettify.js"></script>
    <script type="text/javascript">setTimeout( prettyPrint );</script>

    <script type="text/javascript" src="rsrc_web/ga.js"></script>
    
  </body>
</html>
